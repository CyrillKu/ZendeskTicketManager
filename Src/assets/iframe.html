<html style="overflow-y:auto">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- http://garden.zendesk.com -->
    <link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/2/zendesk_garden.css" type="text/css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
        integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="loader.css">

</head>

<body>
    <div id="content">
        <div class="delimeter" style="max-width: 100%; word-wrap: normal;">
            <div data-container1 class="hidden">
                <span data-smua class="feature-title hidden">SMUA:</span>
                <span data-ps class="feature-title hidden">PS:<i class="fas fa-check"
                        style="color: green; margin: 0 5"></i></span>
            </div>
            <div data-container2 class="hidden">
                <span data-severity class="feature-title hidden">Severity:</span>
                <span data-priority class="feature-title hidden">Priority:</span>
            </div>
        </div>


        <div class="delimeter">
            <div><span class="feature-title border">Reclamations</span><span class="btn"
                    onclick="createNewReclamation()" data-toggle="tooltip" data-placement="top"
                    title="Create New Reclamation"> <i class="fas fa-plus " style="color: green"></i>
                </span></div>

            <ul id="rmList" data-rmList style="margin:10 0">
            </ul>
        </div>
        <div class="delimeter"><span class="feature-title border">Tasks</span>
            <ul id="ftList" data-ftList style="margin:10 0">
            </ul>
        </div>
        <button data-close type="button" class="close close-button hidden" aria-label="Close"
            onclick="removeElementFromList(this)">
            <span aria-hidden="true" style="color: red">&times;</span>
        </button>
        <div class="delimeter"><span class="feature-title border">Linked ticket</span><span data-linkedCreate
                class="btn hidden" onclick="launchLinkedModal()" data-toggle="tooltip" data-placement="top"
                title="Create Ticket for 2nd Line">
                <i class="fas fa-plus " style="color: green"></i>
            </span>
            <section data-linked class="hidden">
                <ul class="linked-body">
                    <li class="info-list__entry u-mt-sm">
                        <span data-line></span>
                        <a data-id></a>
                        <span data-status class="ck_label"></span>
                    </li>
                    <li class="info-list__entry u-mt-sm"><strong>Assignee:</strong>
                        <span data-assignee></span>
                    </li>
                    <li class="info-list__entry u-mt-sm">
                        <p data-subject><strong>Subject: </strong></p>
                    </li>
                </ul>
                </script>
        </div>
        <div class="menu-bottom">
            <button class="btn btn-default btn-sm" onclick="openAboutPage()">About</button>
        </div>
    </div>

    <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
    <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script type="text/javascript" src="helper.js"></script>
    <script type="text/javascript" src="render.js"></script>
    <script>
        var RmApp = {
            settings: {},
            rmHeight: 20,
            initHeight: 240,
            currHeight: null,
            linkedHeight: 100,
            warningHeight: 46,
        }
        var client = ZAFClient.init();
        // получаем список рекламаций из поля reclamations и заполняем список data-rmList при загрузке приложения
        client.on('app.registered', async function (data) {
            RmApp.settings = (await client.metadata()).settings;
            await renderWindow();
            console.log("RecMan v" + (await client.metadata()).version + " is loaded.");
            await updateFollowUps();
        });
        // по сабмиту выполняем запланированные запросы для добавления и удаления рекламаций и тэгов в родительском тикете
        client.on('ticket.save', async function (data) {
            var transfer = false;
            var status = await getValueFromAPI('ticket.status');
            var comment = await getValueFromAPI('ticket.comment');
            if (comment.text.indexOf("#forFL") > -1) transfer = true;
            if (transfer || status == 'pending' || status ==
                'solved') {
                if (comment.text.indexOf("#forSL") < 0 && comment.text != "<p></p>") {
                    var reclamations = await getValueFromField(RmApp.settings.reclamationsFieldId);
                    await transferReclamationsToLinkedTicket(reclamations);
                }
            }
            if (comment.text.indexOf("Revised ETA") > -1) {
                await processEscalation(comment.text);
            }
            // await getReclamationLinkFromComment();
        });
        // при изменении комментария получаем из комментария ссылку на рекламацию и добавляем ее в список data-rmList
        client.on('comment.text.changed', async function (data) {
            await getReclamationLinkFromComment();
        });
        //получаем инфу из modal в родителе
        client.on('recieve_modal_data_trigger', async (data) => {
            var clients = await getAppClients(client);
            await createLinkedTicket(data);
        })

        client.on('ticket.updated', async function () {
            window.location.reload();
        });
        // добавляем ссылку на рекламацию в форму RecMan (нужен рефакторинг!!!)
        async function getReclamationLinkFromComment() {
            var reclamations = await getValueFromField(RmApp.settings.reclamationsFieldId);
            var tasks = await getValueFromField(RmApp.settings.featuresFieldId);
            var comment = await getValueFromAPI('ticket.comment');
            var parser = new DOMParser();
            var doc = parser.parseFromString(comment.text, "text/html");
            var links = Array.from(doc.links);
            //фильтруем все извлеченные из комментария ссылки по ключам 'reclamation' и '/rm/'
            if (links) links.forEach(async link => {
                if (link.href.indexOf('List') < 0) {
                    var number = getNumberFromUrl(link);
                    if (number.match(/^\d+$/)) {
                        if ((link.href.indexOf('reclamation') > -1 || link.href.indexOf('/rm/') > -1)) {
                            if (reclamations && reclamations.indexOf(number) < 0) {
                                reclamations += number + ',';
                                await addLinkField(number, '');
                                addTag('rm' + number);
                            } else if (!reclamations) {
                                reclamations = number + ',';
                                await addLinkField(number, '');
                                addTag('rm' + number);
                            }
                            addTag('reclamation');
                            client.set('ticket.customField:custom_field_' + RmApp.settings
                                .reclamationsFieldId, reclamations);
                        }
                        if (link.href.indexOf('tfs') > -1) {
                            if (tasks && tasks.indexOf(number) < 0) {
                                tasks += number + ',';
                                await addLinkField('', number);
                                addTag('tfs' + number);
                            } else if (!tasks) {
                                tasks = number + ',';
                                await addLinkField('', number);
                                addTag('tfs' + number);
                            }
                            addTag('tfs');
                            client.set('ticket.customField:custom_field_' + RmApp.settings
                                .featuresFieldId, tasks);

                        }
                    }
                }
            });
        }
        //инициализировать процедуру создания дочернего тикета
        async function createLinkedTicket(data) {
            hideLinkedPlus();
            var createUrl = RmApp.settings.serverUrl + 'api/v2/tickets.json';
            var currentTicket = await getValueFromAPI('ticket');
            var createQuery = await createLinkedTicketQuery(currentTicket, data);
            var createFetch = makeFetchBody(createUrl, 'POST', createQuery, null);
            var createResponse = await client.request(createFetch);
            var updateUrl = RmApp.settings.serverUrl + 'api/v2/tickets/' +
                currentTicket.id + '.json';
            var sourceQuery = {
                ticket: {
                    custom_fields: [{
                        id: RmApp.settings.linkedDataFieldId,
                        value: "parent_of:" + createResponse.ticket.id
                    }]
                }
            }
            var updateQuery = JSON.stringify(sourceQuery);
            var updateFetch = makeFetchBody(updateUrl, 'PUT', updateQuery, null);
            await client.request(updateFetch);
            await addLinkedTicketToList(createResponse.ticket.id, true);
        }
        // прокинуть список рекламаций и тэги в Parent Ticket ( на 1 линию), а также оставить сообщение 1 линии об обновлении запроса на 2 линии
        async function transferReclamationsToLinkedTicket(reclamationsFromField) {
            var parentReclamationArray = [];
            var childReclamationArray = [];
            var parentReclamations = null;
            var isParent = null;
            var linkedTicketId = null;
            var linkedData = await getValueFromField(RmApp.settings.linkedDataFieldId);
            if (linkedData && linkedData !== undefined) {
                isParent = (linkedData.indexOf('child') < 0);
                if (isParent) {
                    var status = await getValueFromAPI('ticket.status');
                    var linkedData = await getValueFromField(RmApp.settings.linkedDataFieldId);
                    if (status == 'solved') {
                        linkedTicketId = linkedData.substring(linkedData.indexOf(':') + 1,
                            linkedData.length);
                        var url = RmApp.settings.serverUrl + 'api/v2/tickets/' + linkedTicketId +
                            '.json';
                        var sourceQuery = {
                            ticket: {
                                comment: {
                                    public: false,
                                    body: "Parent ticket has been Solved."
                                }
                            }
                        }
                        var linkedTicket = await getLinkedTicketData(linkedTicketId);
                        if (linkedTicket.status !== 'closed') {
                            var query = JSON.stringify(sourceQuery);
                            var ticketFetch = makeFetchBody(url, 'PUT', query, null);
                            await client.request(ticketFetch);
                        }
                    }
                    return;
                } else {
                    linkedTicketId = linkedData.substring(linkedData.indexOf(':') + 1,
                        linkedData.length);
                    var linkedTicket = await getLinkedTicketData(linkedTicketId);
                    if (linkedTicket.status === 'closed') {
                        linkedTicketId = linkedTicket.followup_ids[linkedTicket.followup_ids
                            .length - 1];
                        if (linkedTicketId !== undefined) {
                            client.set('ticket.customField:custom_field_' + RmApp.settings
                                .linkedDataFieldId,
                                "child_of:" + linkedTicketId);
                            linkedTicket = await getLinkedTicketData(linkedTicketId);
                        }

                    }
                    if (linkedTicket.status !== 'closed') {
                        if (linkedTicket.custom_fields.find(item => item.id == RmApp.settings
                                .reclamationsFieldId).value !== null) {
                            parentReclamations = linkedTicket.custom_fields.find(item =>
                                item.id == RmApp.settings.reclamationsFieldId).value;
                        }

                        if (reclamationsFromField !== null) {
                            childReclamationArray = reclamationsFromField.slice(0, -1).split(',');
                        }
                        if (parentReclamations !== null) {
                            parentReclamationArray = parentReclamations.slice(0, -1).split(',');
                        }
                        var resultSet = [...new Set([...parentReclamationArray, ...
                            childReclamationArray
                        ])];
                        resultSet = resultSet.filter(reclamation => reclamation.length > 5);
                        var url = RmApp.settings.serverUrl + 'api/v2/tickets/' + linkedTicketId +
                            '.json';
                        var tagsUrl = RmApp.settings.serverUrl + 'api/v2/tickets/' +
                            linkedTicketId +
                            '/tags.json';
                        var ticketFetch = makeFetchBody(url, 'PUT', createTicketQuery(resultSet,
                            RmApp
                            .settings
                            .reclamationsFieldId, linkedTicket.status), null);
                        await client.request(ticketFetch);
                        if (resultSet.length > 0) {
                            var tagsFetch = makeFetchBody(tagsUrl, 'PUT', createTagsQuery(
                                resultSet), null);
                            try {
                                await client.request(tagsFetch);
                            } catch (error) {
                                console.log(error);
                            }

                        }
                    }
                }
            } else return true;
        }
        //заполнить запрос на создание Linked Ticekt информацией из полей тикета
        async function createLinkedTicketQuery(currentTicket, data) {
            var currentUser = await client.get('currentUser');
            var query = {
                ticket: {
                    subject: ((currentTicket.organization == undefined) ? "[Organization]" :
                        currentTicket.organization.name) + ' - ' + (await getValueFromField(RmApp.settings
                        .productVersionFieldId)) + ' - ' + data.subject,
                    comment: {
                        body: "*",
                        public: false
                    },
                    status: "new",
                    priority: currentTicket.priority,
                    requester_id: (Object.keys(currentTicket.assignee).length === 0) ? currentUser
                        .currentUser.id : currentTicket.assignee.user.id,
                    assignee_id: (Object.keys(currentTicket.assignee).length === 0) ? currentUser
                        .currentUser
                        .id : currentTicket.assignee.user.id,
                    group_id: (Object.keys(currentTicket.assignee).length === 0) ? currentUser
                        .currentUser
                        .groups[0].id : currentTicket.assignee.group.id,
                    ticket_form_id: currentTicket.form.id,
                    tags: currentTicket.tags,
                    custom_fields: [{
                            id: RmApp.settings.reclamationsFieldId,
                            value: await getValueFromField(RmApp.settings.reclamationsFieldId)
                        },
                        {
                            id: RmApp.settings.buildFieldId,
                            value: await getValueFromField(RmApp.settings.buildFieldId)
                        },
                        {
                            id: RmApp.settings.serialFieldId,
                            value: await getValueFromField(RmApp.settings.serialFieldId)
                        },
                        {
                            id: RmApp.settings.linkedDataFieldId,
                            value: "child_of:" + currentTicket.id
                        },
                    ],
                }
            }
            return JSON.stringify(query);
        }
        //заполнить запрос на комментарий в Parent Ticket
        function createTicketQuery(resultSet, fieldId, status) {
            var source = {
                ticket: {
                    comment: {
                        public: false,
                        body: "Child ticket has been updated. This ticket previous status was: " +
                            status
                            .toUpperCase()
                    },
                    custom_fields: {
                        id: fieldId,
                        value: [...resultSet].join(',') + ','
                    }
                }
            }
            if (status == 'solved') {
                delete source.ticket.comment;
            }
            return JSON.stringify(source);
        }
        //заполнить запрос на теги в Parent Ticket
        function createTagsQuery(resultSet) {
            var source = {
                tags: ["reclamation"]
            }
            resultSet.forEach(function (reclamation) {
                if (reclamation !== '') {
                    source.tags.push('rm' + reclamation);
                }
            });
            return JSON.stringify(source);
        }
    </script>
</body>

</html>